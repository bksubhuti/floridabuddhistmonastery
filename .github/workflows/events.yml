name: Build upcoming-events JSON

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # hourly

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate events.json from Google Calendar ICS
        env:
          ICS_URL: "https://calendar.google.com/calendar/ical/a9990f54cc62171dfef7a892c552c8964dc1a18735784e6d8c36803ce3cffb9b%40group.calendar.google.com/public/basic.ics"
        run: |
          mkdir -p scripts assets
          cat > scripts/generate-events.mjs <<'EOF'
          const ICS_URL = process.env.ICS_URL;

          const text = await fetch(ICS_URL).then(r => {
            if (!r.ok) throw new Error("Failed to fetch ICS: " + r.status);
            return r.text();
          });

          // Split into VEVENT blocks
          const blocks = text.split("BEGIN:VEVENT").slice(1);

          // Minimal parser: pull out DTSTART and SUMMARY (and note all-day)
          const events = [];
          for (const ch of blocks) {
            const endIdx = ch.indexOf("END:VEVENT");
            const body = endIdx >= 0 ? ch.slice(0, endIdx) : ch;

            // Prefer explicit all-day first
            let allDay = false;
            let startRaw = null;

            const mAll = body.match(/DTSTART;VALUE=DATE:(\d{8})/);
            if (mAll) {
              allDay = true;
              startRaw = mAll[1]; // YYYYMMDD
            } else {
              // Any DTSTART variant, grab value after colon
              const mAny = body.match(/DTSTART(?:;[^:]+)?:([0-9T]+Z?)/);
              if (mAny) startRaw = mAny[1]; // e.g., 20251106T130000Z or 20251106T130000
            }

            const mSum = body.match(/SUMMARY:(.+)/);

            if (startRaw && mSum) {
              events.push({
                summary: mSum[1].trim(),
                startRaw,
                allDay
              });
            }
          }

          // Write full list; footer will sort/filter client-side in ET.
          const fs = await import('node:fs/promises');
          await fs.writeFile('assets/events.json', JSON.stringify({ generatedAt: new Date().toISOString(), events }, null, 2));
          console.log("Wrote assets/events.json with", events.length, "events");
          EOF

          node scripts/generate-events.mjs

      - name: Commit changes (if any)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add assets/events.json scripts/generate-events.mjs
            git commit -m "chore: update assets/events.json (auto)"
            git push
          else
            echo "No changes to commit."
          fi
